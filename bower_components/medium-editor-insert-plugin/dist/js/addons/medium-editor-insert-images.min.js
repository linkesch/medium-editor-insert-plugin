/*! 
 * medium-editor-insert-plugin v0.3.2 - jQuery insert plugin for MediumEditor
 *
 * https://github.com/orthes/medium-editor-insert-plugin
 * 
 * Copyright (c) 2014 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */

!function(a){a.fn.mediumInsert.registerAddon("images",{defaults:{useDragAndDrop:!0,imagesUploadScript:"upload.php",imagesDeleteScript:"delete.php",urlPlaceholder:"Paste or type a link",formatData:function(a){var b=new FormData;return b.append("file",a),b},uploadFile:function(b,c,d){a.ajax({type:"post",url:d.options.imagesUploadScript,xhr:function(){var a=new XMLHttpRequest;return a.upload.onprogress=d.updateProgressBar,a},cache:!1,contentType:!1,complete:function(a){d.uploadCompleted(a,b)},processData:!1,data:d.options.formatData(c)})},deleteFile:function(b,c){a.ajax({type:"post",url:c.options.imagesDeleteScript,data:{file:b}})}},init:function(b){b&&b.$el&&(this.$el=b.$el),this.options=a.extend(this.defaults,b),this.setImageEvents(),this.options.useDragAndDrop===!0&&this.setDragAndDropEvents(),this.preparePreviousImages()},insertButton:function(a){var b="Img";return("fontawesome"===a||"object"==typeof a&&a.fontawesome)&&(b='<i class="fa fa-picture-o"></i>'),"object"==typeof a&&a.img&&(b=a.img),'<button data-addon="images" data-action="add" class="medium-editor-action mediumInsert-action">'+b+"</button>"},preparePreviousImages:function(){this.$el.find(".mediumInsert-images").each(function(){var b=a(this).parent();b.hasClass("mediumInsert-placeholder")||b.html(a.fn.mediumInsert.insert.getButtons("images")+'<div class="mediumInsert-placeholder" draggable="true">'+b.html()+"</div>")})},add:function(b){var c,d,e=this;return c=a('<input type="file" multiple="multiple">').click(),c.change(function(){d=this.files,e.uploadFiles(b,d,e)}),a.fn.mediumInsert.insert.deselect(),c},updateProgressBar:function(b){var c,d=a(".progress:first",this.$el);b.lengthComputable&&(c=b.loaded/b.total*100,c=c?c:0,d.attr("value",c),d.html(c))},uploadCompleted:function(b,c){var d,e=a(".progress:first",c);e.attr("value",100),e.html(100),b.responseText?(e.before('<figure class="mediumInsert-images"><img src="'+b.responseText+'" draggable="true" alt=""></figure>'),d=e.siblings("img"),d.load(function(){d.parent().mouseleave().mouseenter()})):(e.before('<div class="mediumInsert-error">There was a problem uploading the file.</div>'),setTimeout(function(){a(".mediumInsert-error:first",c).fadeOut(function(){a(this).remove()})},3e3)),e.remove(),c.closest("[data-medium-element]").trigger("keyup").trigger("input")},uploadFile:function(a,b,c){return c.options.uploadFile(a,b,c)},uploadFiles:function(a,b,c){for(var d={"image/png":!0,"image/jpeg":!0,"image/gif":!0},e=0;e<b.length;e++){var f=b[e];d[f.type]===!0&&(a.append('<progress class="progress" min="0" max="100" value="0">0</progress>'),c.uploadFile(a,f,c))}},deleteFile:function(a,b){return b.options.deleteFile(a,b)},setImageEvents:function(){var b=this;this.$el.on("mouseenter",".mediumInsert-images",function(){var b,c,d=a("img",this);a.fn.mediumInsert.settings.enabled!==!1&&d.length>0&&(a(this).append('<a class="mediumInsert-imageIcon mediumInsert-imageRemove"></a>'),0===a(this).prevAll().length&&a(this).append(a(this).parent().parent().hasClass("small")?'<a class="mediumInsert-imageIcon mediumInsert-imageResizeBigger"></a>':'<a class="mediumInsert-imageIcon mediumInsert-imageResizeSmaller"></a>'),0===a(this).siblings().length&&a(this).append(d.parent().is("a")?'<a class="mediumInsert-imageIcon mediumInsert-imageUnlink"></a>':'<a class="mediumInsert-imageIcon mediumInsert-imageLink"></a>'),b=d.position().top+parseInt(d.css("margin-top"),10),c=d.position().left+d.width()-30,a(".mediumInsert-imageRemove",this).css({right:"auto",top:b,left:c}),a(".mediumInsert-imageResizeBigger, .mediumInsert-imageResizeSmaller",this).css({right:"auto",top:b,left:c-31}),a(".mediumInsert-imageLink, .mediumInsert-imageUnlink",this).css({right:"auto",top:b,left:c-62}))}),this.$el.on("mouseleave",".mediumInsert-images",function(){a(".mediumInsert-imageIcon",this).remove()}),this.$el.on("click",".mediumInsert-imageResizeSmaller",function(){a(this).parent().parent().parent().addClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect(),b.$el.trigger("keyup").trigger("input")}),this.$el.on("click",".mediumInsert-imageResizeBigger",function(){a(this).parent().parent().parent().removeClass("small"),a(this).parent().mouseleave().mouseleave(),a.fn.mediumInsert.insert.deselect(),b.$el.trigger("keyup").trigger("input")}),this.$el.on("click",".mediumInsert-imageRemove",function(){var c=a(this).siblings("img").attr("src");0===a(this).parent().siblings().length&&a(this).parent().parent().parent().removeClass("small"),a(this).parent().remove(),b.deleteFile(c,b),a.fn.mediumInsert.insert.deselect(),b.$el.trigger("keyup").trigger("input")}),this.$el.on("click",".mediumInsert-imageLink",function(){var c=a(this).closest(".mediumInsert-placeholder"),d=a('<div class="medium-editor-toolbar medium-editor-toolbar-active medium-editor-toolbar-form-anchor mediumInsert-imageLinkWire" style="display: block;"><input type="text" value="" placeholder="'+b.options.urlPlaceholder+'" class="mediumInsert-imageLinkText medium-editor-toolbar-anchor-input"></div>');d.appendTo(c),setTimeout(function(){d.find("input").focus()},50),a.fn.mediumInsert.insert.deselect()}),this.$el.on("click",".mediumInsert-imageUnlink",function(){var c=a(this).closest(".mediumInsert-images");c.find("img").unwrap(),a(this).removeClass("mediumInsert-imageUnlink").addClass("mediumInsert-imageLink"),b.$el.trigger("keyup").trigger("input")}),this.$el.on("keypress",".mediumInsert-imageLinkText",function(c){var d=a(this).closest(".mediumInsert-placeholder");if(c.which&&13===c.which||c.keyCode&&13===c.keyCode){d.find(".mediumInsert-images:first").find("img").wrap('<a href="'+a(this).val()+'" target="_blank"></a>'),d.find(".mediumInsert-imageLink").removeClass("mediumInsert-imageLink").addClass("mediumInsert-imageUnlink");try{a(".mediumInsert-imageLinkWire").remove()}catch(e){}b.$el.trigger("keyup").trigger("input")}}).on("blur",".mediumInsert-imageLinkText",function(){a(".mediumInsert-imageLinkWire").remove()}).on("paste",".mediumInsert-imageLinkText",function(b){a.fn.mediumInsert.insert.isFirefox&&b.originalEvent.clipboardData&&a(this).val(b.originalEvent.clipboardData.getData("text/plain"))})},setDragAndDropEvents:function(){var b,c,d=this,e=!1,f=!1;a(document).on("dragover","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&d.$el.addClass("hover")}),a(document).on("dragend","body",function(){a.fn.mediumInsert.settings.enabled!==!1&&d.$el.removeClass("hover")}),this.$el.on("dragover",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).addClass("hover"),a(this).attr("contenteditable",!0))}),this.$el.on("dragleave",".mediumInsert",function(){a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),a(this).attr("contenteditable",!1))}),this.$el.on("dragstart",".mediumInsert .mediumInsert-images img",function(){a.fn.mediumInsert.settings.enabled!==!1&&(b=a(this).parent().index(),c=a(this).parent().parent().parent().attr("id"))}),this.$el.on("dragend",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&e===!0&&(0===a(b.originalEvent.target.parentNode).siblings().length&&a(b.originalEvent.target.parentNode).parent().parent().removeClass("small"),a(b.originalEvent.target.parentNode).mouseleave(),a(b.originalEvent.target.parentNode).remove(),e=!1,f=!1,d.$el.trigger("keyup").trigger("input"))}),this.$el.on("dragover",".mediumInsert .mediumInsert-images img",function(b){a.fn.mediumInsert.settings.enabled!==!1&&b.preventDefault()}),this.$el.on("drop",".mediumInsert .mediumInsert-images img",function(){var e,g,h;if(a.fn.mediumInsert.settings.enabled!==!1){if(c!==a(this).parent().parent().parent().attr("id"))return f=!1,void(b=c=null);e=parseInt(b,10),g=a(this).parent().parent().find(".mediumInsert-images:nth-child("+(e+1)+")"),h=a(this).parent().index(),h>e?g.insertAfter(a(this).parent()):e>h&&g.insertBefore(a(this).parent()),g.mouseleave(),f=!0,b=null,d.$el.trigger("keyup").trigger("input")}}),this.$el.on("drop",".mediumInsert",function(b){var c;b.preventDefault(),a.fn.mediumInsert.settings.enabled!==!1&&(a(this).removeClass("hover"),d.$el.removeClass("hover"),a(this).attr("contenteditable",!1),c=b.originalEvent.dataTransfer.files,c.length>0?d.uploadFiles(a(".mediumInsert-placeholder",this),c,d):f===!0?f=!1:(a(".mediumInsert-placeholder",this).append('<figure class="mediumInsert-images">'+b.originalEvent.dataTransfer.getData("text/html")+"</figure>"),a("meta",this).remove(),e=!0))})}})}(jQuery);