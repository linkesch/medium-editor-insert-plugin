/*! 
 * medium-editor-insert-plugin v1.0.0 - jQuery insert plugin for MediumEditor
 *
 * https://github.com/orthes/medium-editor-insert-plugin
 * 
 * Copyright (c) 2014 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */

this.MediumInsert=this.MediumInsert||{},this.MediumInsert.Templates=this.MediumInsert.Templates||{},this.MediumInsert.Templates["src/js/templates/core-buttons.hbs"]=Handlebars.template({1:function(a,b,c,d){var e,f,g=this.lambda,h=this.escapeExpression,i="function",j=b.helperMissing,k='            <li><a data-addon="'+h(g(d&&d.key,a))+'" data-action="add" class="medium-insert-action">';return f=null!=(f=b.label||(null!=a?a.label:a))?f:j,e=typeof f===i?f.call(a,{name:"label",hash:{},data:d}):f,null!=e&&(k+=e),k+"</a></li>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f='<div class="medium-insert-buttons" contenteditable="false" style="display: none">\n    <a class="medium-insert-buttons-show">+</a>\n    <ul class="medium-insert-buttons-addons" style="display: none">\n';return e=b.each.call(a,null!=a?a.addons:a,{name:"each",hash:{},fn:this.program(1,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"    </ul>\n</div>\n"},useData:!0}),this.MediumInsert.Templates["src/js/templates/core-empty-line.hbs"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(){return"<p><br></p>\n"},useData:!0}),this.MediumInsert.Templates["src/js/templates/embeds-placeholder.hbs"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f="function",g=b.helperMissing,h=this.escapeExpression;return'<div class="medium-insert-embeds-placeholder" contenteditable="false">'+h((e=null!=(e=b.placeholder||(null!=a?a.placeholder:a))?e:g,typeof e===f?e.call(a,{name:"placeholder",hash:{},data:d}):e))+"</div>"},useData:!0}),this.MediumInsert.Templates["src/js/templates/embeds-wrapper.hbs"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f,g="function",h=b.helperMissing,i='<div class="medium-insert-embeds">';return f=null!=(f=b.html||(null!=a?a.html:a))?f:h,e=typeof f===g?f.call(a,{name:"html",hash:{},data:d}):f,null!=e&&(i+=e),i+"</div>"},useData:!0}),this.MediumInsert.Templates["src/js/templates/images-fileupload.hbs"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(){return'<input type="file" multiple>'},useData:!0}),this.MediumInsert.Templates["src/js/templates/images-image.hbs"]=Handlebars.template({1:function(){return'        <div class="medium-insert-images-progress"></div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f,g="function",h=b.helperMissing,i=this.escapeExpression,j='<figure contenteditable="false">\n    <img src="'+i((f=null!=(f=b.img||(null!=a?a.img:a))?f:h,typeof f===g?f.call(a,{name:"img",hash:{},data:d}):f))+'" alt="">\n';return e=b["if"].call(a,null!=a?a.progress:a,{name:"if",hash:{},fn:this.program(1,d),inverse:this.noop,data:d}),null!=e&&(j+=e),j+"</figure>"},useData:!0}),this.MediumInsert.Templates["src/js/templates/images-progressbar.hbs"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(){return'<progress min="0" max="100" value="0">0</progress>'},useData:!0}),this.MediumInsert.Templates["src/js/templates/images-toolbar.hbs"]=Handlebars.template({1:function(a,b,c,d){var e,f="";return e=b["if"].call(a,null!=a?a.label:a,{name:"if",hash:{},fn:this.program(2,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f},2:function(a,b,c,d){var e,f,g=this.lambda,h=this.escapeExpression,i="function",j=b.helperMissing,k='                <li>\n                    <button class="medium-editor-action" data-action="'+h(g(d&&d.key,a))+'">';return f=null!=(f=b.label||(null!=a?a.label:a))?f:j,e=typeof f===i?f.call(a,{name:"label",hash:{},data:d}):f,null!=e&&(k+=e),k+"</button>\n                </li>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(a,b,c,d){var e,f='<div class="medium-insert-images-toolbar medium-editor-toolbar medium-toolbar-arrow-under medium-editor-toolbar-active">\n    <ul class="medium-editor-toolbar-actions clearfix">\n';return e=b.each.call(a,null!=a?a.styles:a,{name:"each",hash:{},fn:this.program(1,d),inverse:this.noop,data:d}),null!=e&&(f+=e),f+"    </ul>\n</div>"},useData:!0}),function(a,b,c){"use strict";function d(a){return a.charAt(0).toUpperCase()+a.slice(1)}function e(c,d){this.el=c,this.$el=a(c),this.templates=b.MediumInsert.Templates,this.options=a.extend(!0,{},g,d),this._defaults=g,this._name=f,d&&d.editor&&(d.editor._serialize=d.editor.serialize,d.editor._deactivate=d.editor.deactivate,d.editor._activate=d.editor.activate,d.editor.serialize=this.editorSerialize,d.editor.deactivate=this.editorDeactivate,d.editor.activate=this.editorActivate),this.init()}var f="mediumInsert",g={editor:null,enabled:!0,addons:{images:!0,embeds:!0}};e.prototype.init=function(){this.$el.addClass("medium-editor-insert-plugin"),("object"!=typeof this.options.addons||0===Object.keys(this.options.addons).length)&&this.disable(),this.initAddons(),this.clean(),this.events()},e.prototype.events=function(){this.$el.on("dragover drop",function(a){a.preventDefault()}).on("blur",a.proxy(this,"addEditorPlaceholder")).on("keyup click",a.proxy(this,"showButtons")).on("selectstart mousedown",".medium-insert, .medium-insert-buttons",a.proxy(this,"disableSelection")).on("keydown",a.proxy(this,"fixSelectAll")).on("click",".medium-insert-buttons-show",a.proxy(this,"toggleAddons")).on("click",".medium-insert-action",a.proxy(this,"addonAction")),a(b).on("resize",a.proxy(this,"positionButtons",null))},e.prototype.editorSerialize=function(){var b=this._serialize();return a.each(b,function(c){var d=a("<div />").html(b[c].value);d.find(".medium-insert-buttons").remove(),b[c].value=d.html()}),b},e.prototype.editorDeactivate=function(){this._deactivate(),a.each(this.elements,function(b,c){a(c).data("plugin_"+f).disable()})},e.prototype.editorActivate=function(){this._activate(),a.each(this.elements,function(b,c){a(c).data("plugin_"+f).enable()})},e.prototype.deselect=function(){c.getSelection().removeAllRanges()},e.prototype.disable=function(){this.options.enabled=!1,this.$el.find(".medium-insert-buttons").addClass("hide")},e.prototype.enable=function(){this.options.enabled=!0,this.$el.find(".medium-insert-buttons").removeClass("hide")},e.prototype.disableSelection=function(b){var c=a(b.target);(c.is("img")===!1||c.hasClass("medium-insert-buttons-show"))&&b.preventDefault()},e.prototype.fixSelectAll=function(a){return this.$el.children().last().removeClass("hide"),(a.ctrlKey||a.metaKey)&&65===a.which?(a.preventDefault(),0===this.$el.find("p").text().trim().length?!1:(this.$el.children().last().addClass("hide"),c.execCommand("selectAll",!1,null))):void 0},e.prototype.addEditorPlaceholder=function(){var a,b=this.$el.clone();b.find(".medium-insert").remove(),a=b.html().replace(/^\s+|\s+$/g,""),(""===a||"<p><br></p>"===a)&&this.$el.addClass("medium-editor-placeholder")},e.prototype.initAddons=function(){var b=this;a.each(this.options.addons,function(a,c){var e=f+d(a);return c===!1?void delete b.options.addons[a]:(b.$el[e](c),void(b.options.addons[a]=b.$el.data("plugin_"+e).options))})},e.prototype.clean=function(){var b,c;this.options.enabled!==!1&&((""===this.$el.html().trim()||"<br>"===this.$el.html().trim())&&this.$el.html(this.templates["src/js/templates/core-empty-line.hbs"]().trim()),this.$el.contents().filter(function(){return"#text"===this.nodeName&&""!==a.trim(a(this).text())}).wrap("<p />"),this.addButtons(),b=this.$el.find(".medium-insert-buttons"),c=b.prev(),c.attr("class")&&c.attr("class").match(/medium\-insert(?!\-active)/)&&b.before(this.templates["src/js/templates/core-empty-line.hbs"]().trim()))},e.prototype.getButtons=function(){return this.options.enabled!==!1?this.templates["src/js/templates/core-buttons.hbs"]({addons:this.options.addons}).trim():void 0},e.prototype.addButtons=function(){0===this.$el.find(".medium-insert-buttons").length&&this.$el.append(this.getButtons())},e.prototype.showButtons=function(c){var d=a(c.target),e=b.getSelection(),f=e.getRangeAt(0),g=a(f.commonAncestorContainer),h=this.$el.find(".medium-insert-buttons"),i=!1,j=g.is("p")?g:g.closest("p");this.clean(),d.hasClass("medium-editor-placeholder")===!1&&0===d.closest(".medium-insert-buttons").length&&0===g.closest(".medium-insert-buttons").length&&(this.$el.find(".medium-insert-active").removeClass("medium-insert-active"),a.each(this.options.addons,function(a){return d.closest(".medium-insert-"+a).length?(g=d,j=d.closest(".medium-insert-"+a),void(i=!0)):void 0}),j.length&&""===j.text().trim()?(j.addClass("medium-insert-active"),i===!1&&(this.positionButtons(g),h.show())):this.hideButtons())},e.prototype.hideButtons=function(){this.$el.find(".medium-insert-buttons").hide(),this.$el.find(".medium-insert-buttons-addons").hide()},e.prototype.positionButtons=function(a){var b,c,d=this.$el.find(".medium-insert-buttons"),e=this.$el.find(".medium-insert-active");b=e.position().left-parseInt(d.find(".medium-insert-buttons-addons").css("left"),10)-parseInt(d.find(".medium-insert-buttons-addons a:first").css("margin-left"),10),b=0>b?e.position().left:b,d.css("left",b),a&&(c=a.position().top+parseInt(a.css("margin-top"),10),d.css("top",c))},e.prototype.toggleAddons=function(){this.$el.find(".medium-insert-buttons-addons").toggle()},e.prototype.hideAddons=function(){this.$el.find(".medium-insert-buttons-addons").hide()},e.prototype.addonAction=function(b){var c=a(b.target).is("a")?a(b.target):a(b.target).closest("a"),e=c.data("addon"),g=c.data("action");this.$el.data("plugin_"+f+d(e))[g]()},e.prototype.moveCaret=function(a){var d,e;d=c.createRange(),e=b.getSelection(),d.setStart(a.get(0).childNodes[0],0),d.collapse(!0),e.removeAllRanges(),e.addRange(d)},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)?"string"==typeof b&&a.data(this,"plugin_"+f)[b]&&a.data(this,"plugin_"+f)[b]():a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document),function(a,b){"use strict";function c(c,e){this.el=c,this.$el=a(c),this.templates=b.MediumInsert.Templates,this.options=a.extend(!0,{},f,e),this._defaults=f,this._name=d,this.init()}var d="mediumInsert",e="Embeds",f={label:'<span class="fa fa-youtube-play"></span>',placeholder:"Paste a YouTube, Vimeo, Facebook, Twitter or Instagram link and press Enter",oembedProxy:"http://medium.iframe.ly/api/oembed?iframe=1"};c.prototype.init=function(){this.events(),this.backwardsCompatibility()},c.prototype.events=function(){this.$el.on("selectstart mousedown",".medium-insert-embeds-placeholder",a.proxy(this,"disablePlaceholderSelection")).on("keyup click",a.proxy(this,"togglePlaceholder")).on("keydown",a.proxy(this,"processLink"))},c.prototype.backwardsCompatibility=function(){this.$el.find(".mediumInsert-embeds").removeClass("mediumInsert-embeds").addClass("medium-insert-embeds")},c.prototype.getCore=function(){return"undefined"==typeof this.core&&(this.core=this.$el.data("plugin_"+d)),this.core},c.prototype.add=function(){var a=this.$el.find(".medium-insert-active");a.html(this.templates["src/js/templates/core-empty-line.hbs"]().trim()),a.is("p")&&(a.replaceWith('<div class="medium-insert-active">'+a.html()+"</div>"),a=this.$el.find(".medium-insert-active"),this.getCore().moveCaret(a)),a.addClass("medium-insert-embeds-input medium-insert-embeds-active"),this.togglePlaceholder({target:a.get(0)}),a.click()},c.prototype.disablePlaceholderSelection=function(b){var c=a(b.target).closest(".medium-insert-embeds-input");b.preventDefault(),b.stopPropagation(),this.getCore().moveCaret(c)},c.prototype.togglePlaceholder=function(c){var d,e,f,g=a(c.target),h=b.getSelection(),i=h.getRangeAt(0),j=a(i.commonAncestorContainer);j.hasClass("medium-insert-embeds-active")?g=j:j.closest(".medium-insert-embeds-active").length&&(g=j.closest(".medium-insert-embeds-active")),g.hasClass("medium-insert-embeds-active")?(d=g.find(".medium-insert-embeds-placeholder"),e=new RegExp(this.options.placeholder,"g"),f=g.text().replace(e,"").trim(),""===f&&0===d.length?g.append(this.templates["src/js/templates/embeds-placeholder.hbs"]({placeholder:this.options.placeholder})):""!==f&&d.length&&d.remove()):this.$el.find(".medium-insert-embeds-active").remove()},c.prototype.processLink=function(a){var b,c,d=this.$el.find(".medium-insert-embeds-active");if(d.length)return b=new RegExp(this.options.placeholder,"g"),c=d.text().replace(b,"").trim(),""===c&&-1!==[8,46,13].indexOf(a.which)?void d.remove():void(13===a.which&&(a.preventDefault(),a.stopPropagation(),this.options.oembedProxy?this.oembed(c):this.parseUrl(c)))},c.prototype.oembed=function(c){var d=this;a.ajax({url:this.options.oembedProxy,dataType:"json",data:{url:c},success:function(b){var c=b&&b.html;b&&!b.html&&"photo"===b.type&&b.url&&(c='<img src="'+b.url+'" alt="">'),a.proxy(d,"embed",c)()},error:function(e,f,g){var h=function(){try{return JSON.parse(e.responseText)}catch(a){}}();b.console.log(h&&h.error||e.status||g.message),a.proxy(d,"convertBadEmbed",c)()}})},c.prototype.parseUrl=function(a){var b;return new RegExp(["youtube","youtu.be","vimeo","instagram"].join("|")).test(a)?(b=a.replace(/\n?/g,"").replace(/^((http(s)?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/(watch\?v=|v\/)?)([a-zA-Z0-9\-_]+)(.*)?$/,'<div class="video"><iframe width="420" height="315" src="//www.youtube.com/embed/$7" frameborder="0" allowfullscreen></iframe></div>').replace(/^http:\/\/vimeo\.com(\/.+)?\/([0-9]+)$/,'<iframe src="//player.vimeo.com/video/$2" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>').replace(/^http:\/\/instagram\.com\/p\/(.+)\/?$/,'<span class="instagram"><iframe src="//instagram.com/p/$1/embed/" width="612" height="710" frameborder="0" scrolling="no" allowtransparency="true"></iframe></span>'),void this.embed(/<("[^"]*"|'[^']*'|[^'">])*>/.test(b)?b:!1)):!1},c.prototype.embed=function(a){var b=this.$el.find(".medium-insert-embeds-active");return a?(b.after(this.templates["src/js/templates/embeds-wrapper.hbs"]({html:a})),b.remove(),this.$el.trigger("input"),-1!==a.indexOf("facebook")&&"undefined"!=typeof FB&&setTimeout(function(){FB.XFBML.parse()},2e3),void 0):(alert("Incorrect URL format specified"),!1)},c.prototype.convertBadEmbed=function(b){var c,d,e,f=this.templates["src/js/templates/core-empty-line.hbs"]().trim();c=this.$el.find(".medium-insert-embeds-active"),e=a(f),c.before(e),c.remove(),e.html(b),d=a(f),e.after(d),this.$el.trigger("input"),this.getCore().moveCaret(c)},a.fn[d+e]=function(b){return this.each(function(){a.data(this,"plugin_"+d+e)||a.data(this,"plugin_"+d+e,new c(this,b))})}}(jQuery,window,document),function(a,b,c){"use strict";function d(c,d){this.el=c,this.$el=a(c),this.templates=b.MediumInsert.Templates,this.options=a.extend(!0,{},g,d),this._defaults=g,this._name=e,this.options.preview&&!b.FileReader&&(this.options.preview=!1),this.init()}var e="mediumInsert",f="Images",g={label:'<span class="fa fa-camera"></span>',uploadScript:"upload.php",deleteScript:"delete.php",preview:!0,styles:{wide:{label:'<span class="fa fa-align-justify"></span>'},left:{label:'<span class="fa fa-align-left"></span>'},right:{label:'<span class="fa fa-align-right"></span>'},grid:{label:'<span class="fa fa-th"></span>'}}};d.prototype.init=function(){this.events(),this.backwardsCompatibility(),this.sorting()},d.prototype.events=function(){a(c).on("click",a.proxy(this,"unselectImage")).on("keydown",a.proxy(this,"removeImage")).on("click",".medium-insert-images-toolbar .medium-editor-action",a.proxy(this,"toolbarAction")),this.$el.on("click",".medium-insert-images img",a.proxy(this,"selectImage"))},d.prototype.backwardsCompatibility=function(){this.$el.find(".mediumInsert").removeClass("mediumInsert").addClass("medium-insert-images"),this.$el.find(".medium-insert-images.small").removeClass("small").addClass("medium-insert-images-left")},d.prototype.getCore=function(){return"undefined"==typeof this.core&&(this.core=this.$el.data("plugin_"+e)),this.core},d.prototype.add=function(){var b=this,c=a(this.templates["src/js/templates/images-fileupload.hbs"]());c.fileupload({url:this.options.uploadScript,dataType:"json",acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,add:function(c,d){a.proxy(b,"uploadAdd",c,d)()},progress:function(c,d){a.proxy(b,"uploadProgress",c,d)()},progressall:function(c,d){a.proxy(b,"uploadProgressall",c,d)()},done:function(c,d){a.proxy(b,"uploadDone",c,d)()}}),c.click()},d.prototype.uploadAdd=function(b,c){var d,e=this.$el.find(".medium-insert-active"),f=this;this.getCore().hideButtons(),e.is("p")&&(e.replaceWith('<div class="medium-insert-active">'+e.html()+"</div>"),e=this.$el.find(".medium-insert-active"),this.getCore().moveCaret(e)),e.addClass("medium-insert-images"),this.options.preview===!1&&0===e.find("progress").length&&e.append(this.templates["src/js/templates/images-progressbar.hbs"]()),(c.autoUpload||c.autoUpload!==!1&&a(b.target).fileupload("option","autoUpload"))&&c.process().done(function(){f.options.preview?(d=new FileReader,d.onload=function(b){a.proxy(f,"showImage",b.target.result,c)()},d.readAsDataURL(c.files[0])):c.submit()})},d.prototype.uploadProgressall=function(a,b){var c,d;this.options.preview===!1&&(c=parseInt(b.loaded/b.total*100,10),d=this.$el.find(".medium-insert-active").find("progress"),d.attr("value",c).text(c),100===c&&d.remove())},d.prototype.uploadProgress=function(a,b){var c,d;this.options.preview&&(c=100-parseInt(b.loaded/b.total*100,10),d=b.context.find(".medium-insert-images-progress"),d.css("width",c+"%"),0===c&&d.remove())},d.prototype.uploadDone=function(b,c){a.proxy(this,"showImage",c.result.files[0].url,c)(),this.getCore().clean(),this.$el.trigger("input"),this.sorting()},d.prototype.showImage=function(b,c){var d;this.options.preview&&c.context?c.context.find("img").attr("src",b):(d=this.$el.find(".medium-insert-active"),c.context=a(this.templates["src/js/templates/images-image.hbs"]({img:b,progress:this.options.preview})).appendTo(d),d.find("br").remove(),this.options.preview&&c.submit())},d.prototype.selectImage=function(b){var c=a(b.target),d=this;c.addClass("medium-insert-image-active"),c.closest(".medium-insert-images").addClass("medium-insert-active"),setTimeout(function(){d.addToolbar()},50)},d.prototype.unselectImage=function(b){var c=a(b.target),d=this.$el.find(".medium-insert-image-active");return c.is("img")&&c.hasClass("medium-insert-image-active")?(d.not(c).removeClass("medium-insert-image-active"),void a(".medium-insert-images-toolbar").remove()):(d.removeClass("medium-insert-image-active"),void a(".medium-insert-images-toolbar").remove())},d.prototype.removeImage=function(b){var c,d,e;(8===b.which||46===b.which)&&(c=this.$el.find(".medium-insert-image-active"),c.length&&(b.preventDefault(),this.deleteFile(c.attr("src")),d=c.closest(".medium-insert-images"),c.closest("figure").remove(),a(".medium-insert-images-toolbar").remove(),0===d.find("figure").length&&(e=a(this.templates["src/js/templates/core-empty-line.hbs"]().trim()),d.before(e),d.remove(),this.getCore().hideAddons(),this.getCore().moveCaret(e)),this.$el.trigger("input")))},d.prototype.deleteFile=function(b){this.options.deleteScript&&a.post(this.options.deleteScript,{file:b})},d.prototype.addToolbar=function(){var b,c=this.$el.find(".medium-insert-image-active"),d=c.closest(".medium-insert-images"),e=!1;b=a(this.templates["src/js/templates/images-toolbar.hbs"]({styles:this.options.styles}).trim()),a("body").append(b),b.css({top:c.offset().top-b.height()-8-2-5,left:c.offset().left+c.width()/2-b.width()/2}).show(),b.find("button").each(function(){d.hasClass("medium-insert-images-"+a(this).data("action"))&&(a(this).addClass("medium-editor-button-active"),e=!0)}),e===!1&&b.find("button").first().addClass("medium-editor-button-active")},d.prototype.toolbarAction=function(b){var c=a(b.target).is("button")?a(b.target):a(b.target).closest("button"),d=c.closest("li"),e=d.closest("ul"),f=e.find("li"),g=this.$el.find(".medium-insert-active"),h=this;c.addClass("medium-editor-button-active"),d.siblings().find(".medium-editor-button-active").removeClass("medium-editor-button-active"),f.find("button").each(function(){var b="medium-insert-images-"+a(this).data("action");a(this).hasClass("medium-editor-button-active")?(g.addClass(b),h.options.styles[a(this).data("action")].added&&h.options.styles[a(this).data("action")].added(g)):(g.removeClass(b),h.options.styles[a(this).data("action")].removed&&h.options.styles[a(this).data("action")].removed(g))}),this.$el.trigger("input")},d.prototype.sorting=function(){var b=this;a(".medium-insert-images").sortable({group:"medium-insert-images",containerSelector:".medium-insert-images",itemSelector:"figure",placeholder:'<figure class="placeholder">',nested:!1,vertical:!1,afterMove:function(){b.$el.trigger("input")}})},a.fn[e+f]=function(b){return this.each(function(){a.data(this,"plugin_"+e+f)||a.data(this,"plugin_"+e+f,new d(this,b))})}}(jQuery,window,document);